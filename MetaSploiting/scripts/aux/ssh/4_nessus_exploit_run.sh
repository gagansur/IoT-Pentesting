#!/bin/bash
## author @Gagandeep k sur
## email gks007@shsu.edu
## copyright @2022

# run search ssh on msfconsole using heredocs and /bin/bash
# heredoc can be used to write multiple commands that will be run in 
# /bin/bash using sudo

# nessus vulnerabilities converted to csv using vulns in 3_generate_nessus.sh
nessus_vulnerabilities=$(awk 'BEGIN { FS="," } { print $4 }' data/nessus_vulns.txt)

## printout allthe vulnerabilities reported from nessus
echo $nessus_vulnerabilities

# iterate over the vulnerabilities 
# check if there is a script with all the options set in it
# if found then run it. 
for arg in $nessus_vulnerabilities
do
# removing extra "" from the name of arg
# e.g. if its "NSS-10234" it becomes NSS-10234 (no quotes)
new_arg=$(echo $arg| tr -d '"')

echo $new_arg

# run msfconsole command to search for that vulnerabilities
# in the database 
# generate a file with that vulnerability name
# file contains all the possible exploits for match the vulnerarability
sudo /bin/bash <<search_arg
command 2>/dev/null
msfconsole -q -x "search linux $new_arg">data/$new_arg.txt
search_arg

echo $new_arg
# if the file (NSS-1234.txt) is generated for the vulnerabilities (NSS-1234)
# it contains the names
# e.g. NSS-10234 -> auxiliary/scanner/ssh/ssh_login
if [[ -f data/$new_arg.txt ]]
then
# read the file and get second column, which contains exploit names 
vulnerabilities=$(awk 'BEGIN { FS=" " } { print $2 }' data/$new_arg.txt)

for vulner in $vulnerabilities
do

if [[ -f cmds/$vulner.sh ]]
then	
# e.g. NSS-10234 -> auxiliary/scanner/ssh/ssh_login
	echo $vulner
	./cmds/$vulner.sh
fi
done
else
	echo "file doesnt exist"
fi

done


